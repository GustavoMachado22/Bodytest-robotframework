
name: CI

on:

  push:
    branches: [ master ]

  workflow_run:
    workflows: ['Development - Build Android']
    types: [ completed ]

jobs:
  run_automation:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
    - uses: actions/checkout@v3
    - name: Install Dependecies
      env:
        PYTHON_VERSION: "3.10"
      run: |
        py_version=$PYTHON_VERSION
        sudo apt update
        sudo apt install software-properties-common
        sudo add-apt-repository -y ppa:deadsnakes/ppa
        sudo apt update
        sudo apt install python"$py_version"
        sudo apt install -y nodejs

    - name: Verify Version
      run: |
          python --version
          nodejs -v
          npm --version
          aws --version

    - name: Install libraries for robot
      run: |
          pip install -U pip
          pip install -r requirements.txt
          python -m Browser.entry init

    - name: Run Tests
      run: |
            mkdir results
            robot -d ./logs tests

    - name: Tests ðŸš¨
      if: ${{ failure() }}
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        header: android
        number: ${{ github.event.workflow_run.pull_requests[0].number }}
        message: |
          Release ${{ github.sha }} to <${{ github.event.repository.html_url }}/pull/${{ github.event.workflow_run.pull_requests[0].number }}>
          Some Android E2E test failed [Click here to see what went wrong](https://customer-test-logs.s3.us-west-2.amazonaws.com/courier-customer-native/${{ github.run_number }}/Androidresults/log.html)

    - name: Tests âœ…
      if: ${{ success() }}
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        header: android
        number: ${{ github.event.workflow_run.pull_requests[0].number }}
        message: |
          Release ${{ github.sha }} to <${{ github.event.repository.html_url }}/pull/${{ github.event.workflow_run.pull_requests[0].number }}>
          All Android E2E tests [passed](https://customer-test-logs.s3.us-west-2.amazonaws.com/courier-customer-native/${{ github.run_number }}/Androidresults/log.html), you're good to go!